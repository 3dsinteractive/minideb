#!/bin/bash

set -e
set -u

ONLY_IF_CHANGED=${ONLY_IF_CHANGED:-}

if [ "${TRAVIS_EVENT_TYPE:-}" == "cron" ]; then
    ONLY_IF_CHANGED=true
fi

DISTS="jessie
unstable
wheezy
latest
"

BASENAME=bitnami/minideb
GCR_BASENAME=gcr.io/bitnami-containers/minideb

if [ -n "${DOCKER_PASSWORD:-}" ]; then
    docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
fi

if [ -n "${GCR_KEY:-}" ]; then
    gcloud auth activate-service-account $GCR_EMAIL --key-file <(echo "$GCR_KEY")
fi

for DIST in $DISTS; do
    if [ -n ${ONLY_IF_CHANGED} ]; then
        docker tag $BASENAME:$DIST $BASENAME:$DIST-save
        if docker pull $BASENAME:$DIST; then
            if ./dockerdiff $BASENAME:$DIST $BASENAME:$DIST-save; then
                echo "Not pushing $DIST as it has not changed"
                continue
            fi
        fi
        docker tag $BASENAME:$DIST-save $BASENAME:$DIST
    fi
    docker push $BASENAME:$DIST
    gcloud docker push $GCR_BASENAME:$DIST
done
